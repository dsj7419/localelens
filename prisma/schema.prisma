// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

// ============================================
// LocaleLens Data Models
// ============================================

/// A localization project containing a base image and its variants
model Project {
    id            String    @id @default(cuid())
    name          String
    baseImagePath String?   // Path to base image in .local-data
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    mask          Mask?
    variants      Variant[]
    imageAnalysis ImageAnalysis?

    @@index([name])
    @@index([createdAt])
}

/// Vision-powered image analysis results (GPT-4o Vision)
/// Stores detected text regions, layout type, and metadata for dynamic prompt generation
model ImageAnalysis {
    id             String   @id @default(cuid())
    projectId      String   @unique
    textRegions    String   // JSON array of TextRegion objects
    layout         String   // ImageLayout type (app-screenshot, sticky-notes, etc.)
    surfaceTexture String   // Description of background/surface
    dominantColors String   // JSON array of color names
    hasUIElements  Boolean  @default(false)
    uiElements     String?  // JSON array of UI element descriptions
    imageDescription String // Overall description of the image
    analyzedAt     DateTime @default(now())

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

/// A mask defining editable regions for a project
model Mask {
    id            String   @id @default(cuid())
    projectId     String   @unique
    maskImagePath String   // Path to mask image in .local-data
    createdAt     DateTime @default(now())

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

/// A generated variant for a specific locale
model Variant {
    id              String      @id @default(cuid())
    projectId       String
    locale          String      // e.g., "es-MX", "fr-CA", "ar"
    prompt          String      // The prompt used for generation
    outputImagePath String      // Path to output image in .local-data
    driftScore      Float?      // Percentage of pixels changed outside mask
    driftStatus     DriftStatus @default(PENDING)
    modelUsed       String?     // The model that generated this variant
    createdAt       DateTime    @default(now())

    // Verification fields (Sprint 9)
    translationAccuracy  Float?   // Percentage of translations that rendered correctly (0-100)
    verificationStatus   String?  // "pass" | "warn" | "fail"
    verificationDetails  String?  // JSON string of VerificationResult with match details

    // Relations
    project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([projectId, locale])
    @@index([projectId])
    @@index([locale])
}

/// Status of drift analysis for a variant
enum DriftStatus {
    PENDING // Not yet analyzed
    PASS    // Drift <= 2%
    WARN    // Drift 2-5%
    FAIL    // Drift > 5%
}
